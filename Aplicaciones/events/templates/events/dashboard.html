{% extends 'control/control_index.html' %}
{% load static %}

{% block title %}Dashboard - Proxy Firewall{% endblock %}

{% block sidebar_menu %}
<li class="sidebar-header">NAVEGACION</li>
<li>
  <a href="/control/" class="active">
    <i class="zmdi zmdi-view-dashboard"></i> <span>Control</span>
  </a>
</li>
{{ block.super }}
{% endblock %}

{% block content %}
<style>
    :root {
        --primary: #2563eb;
        --success: #059669;
        --danger: #dc2626;
        --warning: #d97706;
        --dark: #1e293b;
        --gray: #64748b;
        --light: #f8fafc;
        --border: #e2e8f0;
    }
    
    .dashboard-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 24px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        backdrop-filter: blur(10px);
        max-width: 1600px;
        margin: 0 auto;
    }
    
    .header-gradient {
        background: linear-gradient(135deg, var(--primary) 0%, #4f46e5 100%);
        border-radius: 16px;
        padding: 1.5rem;
        color: white;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 16px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        height: 100%;
    }
    
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
    }
    
    .stat-card .icon-wrapper {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
    }
    
    .bg-gradient-primary {
        background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    }
    
    .bg-gradient-danger {
        background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
    }
    
    .bg-gradient-success {
        background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
    }
    
    .bg-gradient-warning {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    }
    
    .badge-status {
        padding: 0.5rem 1rem;
        border-radius: 100px;
        font-weight: 500;
        font-size: 0.875rem;
    }
    
    .badge-deny {
        background: #fee2e2;
        color: var(--danger);
        border: 1px solid #fecaca;
        border-radius: 100px;
        font-weight: 500;
        display: inline-block;
    }
    
    .badge-allow {
        background: #d1fae5;
        color: var(--success);
        border: 1px solid #a7f3d0;
        border-radius: 100px;
        font-weight: 500;
        display: inline-block;
    }
    
    .dashboard-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 1.5rem;
        height: 100%;
        transition: all 0.3s ease;
    }
    
    .dashboard-card:hover {
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
    }
    
    .card-header-custom {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.25rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border);
    }
    
    .card-header-custom h5 {
        font-weight: 600;
        color: var(--dark);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-refresh {
        background: white;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--gray);
        transition: all 0.2s ease;
    }
    
    .btn-refresh:hover {
        background: var(--light);
        border-color: var(--primary);
        color: var(--primary);
    }
    
    .btn-export {
        background: var(--primary);
        border: none;
        border-radius: 10px;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: white;
        transition: all 0.2s ease;
    }
    
    .btn-export:hover {
        background: #1d4ed8;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    
    .table-custom {
        border-collapse: separate;
        border-spacing: 0 8px;
        margin: 0;
        width: 100%;
    }
    
    .table-custom thead th {
        background: var(--light);
        border: none;
        padding: 1rem;
        font-weight: 600;
        color: var(--gray);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .table-custom tbody tr {
        background: white;
        border-radius: 12px;
        transition: all 0.2s ease;
    }
    
    .table-custom tbody tr:hover {
        background: var(--light);
        transform: scale(1.01);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .table-custom td {
        padding: 1rem;
        vertical-align: middle;
        border: none;
        border-bottom: 1px solid var(--border);
    }
    
    .domain-tag {
        background: #eef2ff;
        color: var(--primary);
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.813rem;
        font-weight: 500;
        display: inline-block;
        margin: 0.125rem;
    }
    
    .squid-status {
        background: var(--light);
        border-radius: 16px;
        padding: 1.25rem;
    }
    
    .progress-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.75rem;
    }
    
    .stat-label {
        color: var(--gray);
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .stat-value {
        font-weight: 700;
        color: var(--dark);
    }
    
    .chart-container {
        position: relative;
        height: 250px;
        width: 100%;
        margin-top: 1rem;
    }
    
    .text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    @media (max-width: 768px) {
        .dashboard-container { padding: 1rem; }
        .header-gradient { padding: 1rem; }
    }
</style>

<div class="container-fluid p-4">
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header-gradient d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <h1 class="h2 mb-2 fw-bold">üîí Proxy Firewall Auditor√≠a</h1>
                <p class="mb-0 opacity-90">
                    <i class="fas fa-shield-alt me-2"></i>
                    Monitoreo en tiempo real - Bloqueos, tr√°fico y cach√©
                </p>
            </div>
            <div class="d-flex gap-3 align-items-center mt-3 mt-md-0">
                <div class="text-end bg-white bg-opacity-20 p-3 rounded-3">
                    <small class="text-white text-opacity-75 d-block mb-1">Estado DB</small>
                    {% if db_status.ok %}
                        <span class="badge-status bg-white text-success fw-bold">
                            <i class="fas fa-check-circle me-1"></i> Conectada
                        </span>
                    {% else %}
                        <span class="badge-status bg-white text-danger fw-bold" title="{{ db_status.msg }}">
                            <i class="fas fa-exclamation-triangle me-1"></i> Error
                        </span>
                    {% endif %}
                </div>
                <div class="btn-group gap-2">
                    <button id="btnRefresh" class="btn-refresh">
                        <i class="fas fa-sync-alt me-2"></i>Refrescar
                    </button>
                    <button id="btnExport" class="btn-export">
                        <i class="fas fa-download me-2"></i>Exportar CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="stat-card p-4">
                    <div class="d-flex align-items-center">
                        <div class="icon-wrapper bg-gradient-primary text-white me-3">
                            üìä
                        </div>
                        <div>
                            <span class="text-muted small text-uppercase fw-bold">Total Requests</span>
                            <h2 class="mb-0 fw-bold">{{ total_requests|default:'0' }}</h2>
                            <small class="text-muted">Tr√°fico total</small>
                        </div>
                    </div>
                    <div class="progress-stats mt-3">
                        <span class="stat-label">√öltima hora</span>
                        <span class="stat-value">+{{ recent_requests|length|default:'0' }}</span>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="stat-card p-4 border-danger">
                    <div class="d-flex align-items-center">
                        <div class="icon-wrapper bg-gradient-danger text-white me-3">
                            üö´
                        </div>
                        <div>
                            <span class="text-muted small text-uppercase fw-bold">Bloqueos</span>
                            <h2 class="mb-0 fw-bold text-danger">{{ total_blocked|default:'0' }}</h2>
                            <small class="text-muted">Eventos DENY</small>
                        </div>
                    </div>
                    <div class="progress-stats mt-3">
                        <span class="stat-label">% del total</span>
                        <span class="stat-value text-danger">
                            {% if total_requests > 0 %}
                                {{ total_blocked|floatformat:2 }}%
                            {% else %}0%{% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="stat-card p-4">
                    <div class="d-flex align-items-center">
                        <div class="icon-wrapper bg-gradient-success text-white me-3">
                            üíæ
                        </div>
                        <div>
                            <span class="text-muted small text-uppercase fw-bold">Cache Entries</span>
                            <h2 class="mb-0 fw-bold">{{ cache_entries_count|default:'0' }}</h2>
                            <small class="text-muted">Entradas activas</small>
                        </div>
                    </div>
                    <div class="progress-stats mt-3">
                        <span class="stat-label">Hit ratio</span>
                        <span class="stat-value text-success">
                            {% if cache_stats.HITS and cache_stats.MISSES %}
                                {% with total=cache_stats.HITS|add:cache_stats.MISSES %}
                                    {% if total > 0 %}
                                        {{ cache_stats.HITS|floatformat:2 }}%
                                    {% else %}0%{% endif %}
                                {% endwith %}
                            {% else %}0%{% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="stat-card p-4">
                    <div class="d-flex align-items-center">
                        <div class="icon-wrapper bg-gradient-warning text-white me-3">
                            ‚ö°
                        </div>
                        <div>
                            <span class="text-muted small text-uppercase fw-bold">Cache Stats</span>
                            <div class="mt-2">
                                {% for k,v in cache_stats.items|slice:":2" %}
                                    <div class="d-flex justify-content-between small">
                                        <span>{{ k }}:</span>
                                        <strong>{{ v }}</strong>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Squid Status Card -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="dashboard-card">
                    <div class="card-header-custom">
                        <h5>
                            <span class="badge bg-primary bg-opacity-10 p-2 rounded-3">ü¶ë</span>
                            Estado de Integraci√≥n Squid
                        </h5>
                        {% if squid_status.allow_read %}
                            <span class="badge-status bg-success bg-opacity-10 text-success">
                                <i class="fas fa-check-circle me-1"></i> Lectura habilitada
                            </span>
                        {% endif %}
                    </div>
                    
                    <div class="squid-status">
                        <div class="row g-4">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <span class="badge bg-secondary bg-opacity-10 p-3 rounded-3">üìÅ</span>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Config path</small>
                                        <code class="fw-bold">{{ squid_status.config_path|default:'No configurado' }}</code>
                                        {% if squid_status.config_exists %}
                                            <span class="badge bg-success bg-opacity-10 text-success ms-2">‚úì</span>
                                        {% else %}
                                            <span class="badge bg-warning bg-opacity-10 text-warning ms-2">‚ö†</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <span class="badge bg-secondary bg-opacity-10 p-3 rounded-3">üö´</span>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Blocked list</small>
                                        <code class="fw-bold">{{ squid_status.blocked_list_path|default:'No configurado' }}</code>
                                        {% if squid_status.blocked_exists %}
                                            <span class="badge bg-success ms-2">{{ squid_status.blocked_count }} entries</span>
                                            {% if squid_status.blocked_mtime %}
                                                <small class="text-muted d-block">{{ squid_status.blocked_mtime }}</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-danger ms-2">No disponible</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            {% if squid_status.blocked_sample %}
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <span class="badge bg-secondary bg-opacity-10 p-3 rounded-3">üåê</span>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Sample domains</small>
                                        <div>
                                            {% for d in squid_status.blocked_sample|slice:":5" %}
                                                <span class="domain-tag">{{ d }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        {% if squid_status.errors %}
                            <div class="alert alert-danger mt-3 mb-0">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                Errores: {{ squid_status.errors|join:", " }}
                            </div>
                        {% endif %}
                        
                        {% if not squid_status.allow_read %}
                            <div class="alert alert-info mt-3 mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Lectura de archivos Squid deshabilitada (SQUID_ALLOW_READ=false)
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="dashboard-card h-100">
                    <div class="card-header-custom">
                        <h5>
                            <span class="badge bg-danger bg-opacity-10 p-2 rounded-3">üìä</span>
                            Sitios m√°s bloqueados
                        </h5>
                        <span class="badge bg-danger">{{ top_blocked_sites|length }} dominios</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="chartBlockedSites"></canvas>
                    </div>
                    <div class="mt-4">
                        {% for s in top_blocked_sites|slice:":5" %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-truncate" style="max-width: 70%;">{{ s.host }}</span>
                                <span class="badge bg-danger bg-opacity-10 text-danger px-3 py-2">{{ s.count }}</span>
                            </div>
                        {% empty %}
                            <p class="text-muted text-center py-4">No hay bloqueos a√∫n</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="dashboard-card h-100">
                    <div class="card-header-custom">
                        <h5>
                            <span class="badge bg-primary bg-opacity-10 p-2 rounded-3">üë•</span>
                            IPs m√°s activas
                        </h5>
                        <span class="badge bg-primary">{{ top_ips|length }} direcciones</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="chartTopIPs"></canvas>
                    </div>
                    <div class="mt-4">
                        {% for i in top_ips|slice:":5" %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><code>{{ i.ip }}</code></span>
                                <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2">{{ i.count }} req</span>
                            </div>
                        {% empty %}
                            <p class="text-muted text-center py-4">No hay actividad a√∫n</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Requests & Cache Stats -->
        <div class="row g-4">
            <div class="col-md-8">
                <div class="dashboard-card">
                    <div class="card-header-custom">
                        <h5>
                            <span class="badge bg-info bg-opacity-10 p-2 rounded-3">üïí</span>
                            Requests Recientes
                        </h5>
                        <span class="badge bg-info">{{ recent_requests|length }} registros</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table-custom">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Cliente</th>
                                    <th>URL</th>
                                    <th>Veredicto</th>
                                    <th>Raz√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in recent_requests|slice:":8" %}
                                <tr>
                                    <td class="text-nowrap">
                                        <small class="text-muted">{{ r.ts|slice:"0:19" }}</small>
                                    </td>
                                    <td><code>{{ r.client_ip }}</code></td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 200px;">
                                            {% if r.url %}
                                                <span class="domain-tag">{{ r.url.host }}</span>
                                                <small class="text-muted">{{ r.url.path|truncatechars:20 }}</small>
                                            {% else %}-{% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        {% if r.verdict == 'DENY' %}
                                            <span class="badge-deny px-3 py-2">
                                                <i class="fas fa-ban me-1"></i>DENY
                                            </span>
                                        {% else %}
                                            <span class="badge-allow px-3 py-2">
                                                <i class="fas fa-check me-1"></i>ALLOW
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ r.block_reason|default:'-'|truncatechars:20 }}</small>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-5">
                                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">No hay requests registrados</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="dashboard-card h-100">
                    <div class="card-header-custom">
                        <h5>
                            <span class="badge bg-warning bg-opacity-10 p-2 rounded-3">üíø</span>
                            Cache Performance
                        </h5>
                    </div>
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="chartCache"></canvas>
                    </div>
                    <div class="mt-4">
                        {% for k,v in cache_stats.items %}
                            <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded-3">
                                <span class="fw-medium">{{ k }}</span>
                                <span class="badge bg-dark">{{ v }}</span>
                            </div>
                        {% empty %}
                            <p class="text-muted text-center">No hay estad√≠sticas de cach√©</p>
                        {% endfor %}
                        
                        <div class="mt-4 p-3 bg-primary bg-opacity-10 rounded-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold text-primary">Eficiencia de cach√©</span>
                                <span class="h5 mb-0 text-primary">
                                    {% if cache_stats.HITS and cache_stats.MISSES %}
                                        {% with total=cache_stats.HITS|add:cache_stats.MISSES %}
                                            {% if total > 0 %}
                                                {{ cache_stats.HITS|floatformat:1 }}%
                                            {% else %}0%{% endif %}
                                        {% endwith %}
                                    {% else %}0%{% endif %}
                                </span>
                            </div>
                            <div class="progress mt-2" style="height: 8px;">
                                {% if cache_stats.HITS and cache_stats.MISSES %}
                                    {% with total=cache_stats.HITS|add:cache_stats.MISSES %}
                                        {% if total > 0 %}
                                            {% with ratio=cache_stats.HITS %}
                                                <div class="progress-bar bg-primary" style="width: {{ ratio }}%"></div>
                                            {% endwith %}
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://kit.fontawesome.com/your-kit-id.js" crossorigin="anonymous"></script>
<script src="{% static 'assets/plugins/Chart.js/Chart.min.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        try {
            const chartData = JSON.parse('{{ chart_data|escapejs }}');
            
            // Configuraci√≥n global de Chart.js
            if (window.Chart) {
                if (Chart.defaults.global) {
                    Chart.defaults.global.defaultFontFamily = "'Inter', sans-serif";
                    Chart.defaults.global.defaultFontSize = 12;
                }
                
                // Gr√°fico de sitios bloqueados
                const chartBlocked = document.getElementById('chartBlockedSites');
                if (chartBlocked && chartData.top_blocked_sites && chartData.top_blocked_sites.length > 0) {
                    new Chart(chartBlocked.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: chartData.top_blocked_sites.map(x => {
                                if (x.host) {
                                    return x.host.length > 15 ? x.host.substring(0, 12) + '...' : x.host;
                                }
                                return 'Unknown';
                            }),
                            datasets: [{
                                label: 'Bloqueos',
                                data: chartData.top_blocked_sites.map(x => x.count || 0),
                                backgroundColor: 'rgba(220,38,38,0.7)',
                                borderRadius: 6,
                                barPercentage: 0.6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { 
                                    beginAtZero: true, 
                                    grid: { display: false },
                                    ticks: { stepSize: 1 }
                                },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }
                
                // Gr√°fico de IPs
                const chartIPs = document.getElementById('chartTopIPs');
                if (chartIPs && chartData.top_ips && chartData.top_ips.length > 0) {
                    new Chart(chartIPs.getContext('2d'), {
                        type: 'horizontalBar',
                        data: {
                            labels: chartData.top_ips.map(x => x.ip || 'Unknown'),
                            datasets: [{
                                label: 'Requests',
                                data: chartData.top_ips.map(x => x.count || 0),
                                backgroundColor: 'rgba(37,99,235,0.7)',
                                borderRadius: 6,
                                barPercentage: 0.6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                x: { 
                                    beginAtZero: true, 
                                    grid: { display: false },
                                    ticks: { stepSize: 1 }
                                },
                                y: { grid: { display: false } }
                            }
                        }
                    });
                }
                
                // Gr√°fico de cach√©
                const chartCache = document.getElementById('chartCache');
                if (chartCache && chartData.cache_stats) {
                    const cacheLabels = Object.keys(chartData.cache_stats);
                    const cacheValues = cacheLabels.map(k => chartData.cache_stats[k] || 0);
                    
                    if (cacheLabels.length > 0) {
                        new Chart(chartCache.getContext('2d'), {
                            type: 'doughnut',
                            data: {
                                labels: cacheLabels,
                                datasets: [{
                                    data: cacheValues,
                                    backgroundColor: ['#059669', '#d97706', '#6b7280', '#2563eb', '#dc2626'],
                                    borderWidth: 0,
                                    hoverOffset: 8
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                cutoutPercentage: 70,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: { usePointStyle: true, boxWidth: 8 }
                                    }
                                }
                            }
                        });
                    }
                }
            }
        } catch(e) {
            console.error('Error initializing charts:', e);
        }
    });
    
    // Funcionalidad de refresh
    document.getElementById('btnRefresh')?.addEventListener('click', function() {
        location.reload();
    });
    
    // Funcionalidad de export CSV
    document.getElementById('btnExport')?.addEventListener('click', function() {
        try {
            const rows = [
                ['Timestamp', 'Cliente IP', 'URL', 'Veredicto', 'Raz√≥n']
            ];
            
            {% for r in recent_requests %}
            rows.push([
                '{{ r.ts|escapejs }}',
                '{{ r.client_ip|escapejs }}',
                '{% if r.url %}{{ r.url.host|escapejs }}{% endif %}',
                '{{ r.verdict|escapejs }}',
                '{{ r.block_reason|default:""|escapejs }}'
            ]);
            {% endfor %}
            
            let csvContent = rows.map(row => 
                row.map(cell => {
                    if (typeof cell === 'string' && (cell.includes(',') || cell.includes('"'))) {
                        return `"${cell.replace(/"/g, '""')}"`;
                    }
                    return cell;
                }).join(',')
            ).join('\n');
            
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'proxy_audit_{{ now|date:"Y-m-d_H-i" }}.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        } catch(e) {
            console.error('Error exporting CSV:', e);
            alert('Error al exportar CSV');
        }
    });
</script>

<!-- Font Awesome fallback -->
<script>
    // Fallback para Font Awesome
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            if (typeof window.FontAwesome === 'undefined') {
                document.querySelectorAll('[class*="fa-"]').forEach(el => {
                    if (el.classList.contains('fa-sync-alt')) el.innerHTML = 'üîÑ';
                    else if (el.classList.contains('fa-download')) el.innerHTML = '‚¨áÔ∏è';
                    else if (el.classList.contains('fa-check-circle')) el.innerHTML = '‚úì';
                    else if (el.classList.contains('fa-exclamation-triangle')) el.innerHTML = '‚ö†';
                    else if (el.classList.contains('fa-ban')) el.innerHTML = 'üö´';
                    else if (el.classList.contains('fa-check')) el.innerHTML = '‚úì';
                    else if (el.classList.contains('fa-exclamation-circle')) el.innerHTML = '!';
                    else if (el.classList.contains('fa-info-circle')) el.innerHTML = 'i';
                    else if (el.classList.contains('fa-inbox')) el.innerHTML = 'üì•';
                    else if (el.classList.contains('fa-shield-alt')) el.innerHTML = 'üõ°Ô∏è';
                });
            }
        }, 1000);
    });
</script>
{% endblock %}